<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG to Font Converter</title>
</head>
<body>
    <h1>SVG to Font Converter</h1>

    <!-- フォルダをアップロードするためのインプット -->
    <input type="file" id="svgFolder" webkitdirectory multiple accept=".svg">
    <button id="convertButton">フォントに変換してダウンロード</button>
    <a id="downloadLink" style="display:none;">フォントをダウンロード</a>

    <script src="https://cdn.jsdelivr.net/npm/opentype.js@latest"></script>
    <script>
        document.getElementById('convertButton').addEventListener('click', function () {
            const input = document.getElementById('svgFolder');
            const files = input.files;

            if (files.length === 0) {
                alert('SVGファイルを含むフォルダを選択してください');
                return;
            }

            const glyphs = [];
            let fontSlot = 0x4E00; // UnicodeのCJK統合漢字領域を使用
            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                if (file.type === "image/svg+xml") { // SVGファイルのみ処理
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const svgData = event.target.result;

                        try {
                            const parser = new DOMParser();
                            const svgDoc = parser.parseFromString(svgData, "image/svg+xml");
                            const paths = [];

                            // path要素を取得
                            svgDoc.querySelectorAll('path').forEach(path => {
                                const d = path.getAttribute("d");
                                if (d) {
                                    paths.push(d);
                                }
                            });

                            // line要素を取得
                            svgDoc.querySelectorAll('line').forEach(line => {
                                const x1 = parseFloat(line.getAttribute("x1"));
                                const y1 = parseFloat(line.getAttribute("y1"));
                                const x2 = parseFloat(line.getAttribute("x2"));
                                const y2 = parseFloat(line.getAttribute("y2"));
                                paths.push(`M${x1},${y1} L${x2},${y2}`);
                            });

                            // rect要素を取得
                            svgDoc.querySelectorAll('rect').forEach(rect => {
                                const x = parseFloat(rect.getAttribute("x"));
                                const y = parseFloat(rect.getAttribute("y"));
                                const width = parseFloat(rect.getAttribute("width"));
                                const height = parseFloat(rect.getAttribute("height"));
                                paths.push(`M${x},${y} H${x + width} V${y + height} H${x} Z`);
                            });

                            // circle要素を取得
                            svgDoc.querySelectorAll('circle').forEach(circle => {
                                const cx = parseFloat(circle.getAttribute("cx"));
                                const cy = parseFloat(circle.getAttribute("cy"));
                                const r = parseFloat(circle.getAttribute("r"));
                                paths.push(`M${cx - r},${cy} A${r},${r} 0 1,0 ${cx + r},${cy} A${r},${r} 0 1,0 ${cx - r},${cy} Z`);
                            });

                            // パスを一つにまとめる
                            const fullPath = paths.join(" ");

                            // パスデータからOpentype.jsのパスを作成
                            const opentypePath = opentype.Path.fromSVG(fullPath);

                            // グリフを作成
                            const glyph = new opentype.Glyph({
                                name: file.name.split('.')[0], // ファイル名をグリフ名に
                                unicode: fontSlot++, // Unicodeスロットを割り当て
                                advanceWidth: 1000, // グリフ幅
                                path: opentypePath
                            });

                            glyphs.push(glyph);
                        } catch (error) {
                            console.error(`ファイル ${file.name} の処理中にエラーが発生しました:`, error);
                        }

                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            createFont(glyphs);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    filesProcessed++;
                }
            });
        });

        function createFont(glyphs) {
            if (glyphs.length === 0) {
                alert("フォントを作成するためのSVGファイルが見つかりませんでした。");
                return;
            }

            const font = new opentype.Font({
                familyName: 'CustomFont',
                styleName: 'Regular',
                unitsPerEm: 1000,
                glyphs: glyphs
            });

            // フォントデータをバッファに変換しダウンロード
            font.download();
        }
    </script>
</body>
</html>
