<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG to Font Converter</title>
</head>
<body>
    <h1>SVG to Font Converter</h1>
    
    <input type="file" id="svgFiles" webkitdirectory multiple accept=".svg">
    <button id="convertButton">フォントに変換してダウンロード</button>
    <div id="fileList"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/opentype.js/0.6.5/opentype.min.js" integrity="sha512-bRz6QInwm6Dnvgt0oVNbSjs0eyLXmAttb8t/jZWbBTTnUrs0O3HtNYE6pf3K0gO5RwUJZ50OzJcIiYi8lWj7EA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const fileListDiv = document.getElementById('fileList');
        const glyphs = [];
        let fontSlot = 0x4E00; // Unicodeの開始点

        document.getElementById('svgFiles').addEventListener('change', function () {
            fileListDiv.innerHTML = ''; // アップロードされたファイルリストをリセット
            Array.from(this.files).forEach(file => {
                const listItem = document.createElement('div');
                listItem.textContent = file.name;
                fileListDiv.appendChild(listItem);
            });
        });

        document.getElementById('convertButton').addEventListener('click', function () {
            const input = document.getElementById('svgFiles');
            const files = input.files;

            if (files.length === 0) {
                alert('SVGファイルを選択してください');
                return;
            }

            let filesProcessed = 0;

            Array.from(files).forEach(file => {
                if (file.type === "image/svg+xml") {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const svgData = event.target.result;

                        try {
                            const parser = new DOMParser();
                            const svgDoc = parser.parseFromString(svgData, "image/svg+xml");
                            const svgElement = svgDoc.querySelector('svg');

                            if (!svgElement) {
                                console.error(`ファイル ${file.name} に <svg> 要素が見つかりません`);
                                return;
                            }

                            const paths = [];
                            svgElement.querySelectorAll('path').forEach(child => {
                                const pathData = child.getAttribute('d');
                                if (pathData) {
                                    // fromSVGを使ってPathオブジェクトを作成
                                    const opentypePath = opentype.Path.fromSVG(pathData);
                                    paths.push(opentypePath);
                                }
                            });

                            // グリフを作成
                            if (paths.length > 0) {
                                const glyph = new opentype.Glyph({
                                    name: file.name.split('.')[0],
                                    unicode: fontSlot++, 
                                    advanceWidth: 1000,
                                    path: paths[0] // 最初のパスを使用
                                });

                                glyphs.push(glyph);
                            }
                        } catch (error) {
                            console.error(`ファイル ${file.name} の処理中にエラーが発生しました:`, error);
                        }

                        filesProcessed++;
                        if (filesProcessed === files.length) {
                            createFont(glyphs);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    filesProcessed++;
                }
            });
        });

        function createFont(glyphs) {
            if (glyphs.length === 0) {
                alert("フォントを作成するためのSVGファイルが見つかりませんでした。");
                return;
            }

            const font = new opentype.Font({
                familyName: 'CustomFont',
                styleName: 'Regular',
                unitsPerEm: 1000,
                glyphs: glyphs
            });

            // フォントデータをバイナリに変換し、Blobを生成
            const fontData = font.toArrayBuffer();
            const blob = new Blob([fontData], { type: 'font/ttf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'custom_font.ttf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
